<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LBS Study Group Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>LBS Study Group Manager</h1>
            <p class="subtitle">Automated assignment extraction and room booking</p>
        </header>

        <div class="dashboard">
            <!-- Assignment Extraction Card -->
            <div class="card">
                <div class="card-header">
                    <h2>Assignment Extraction</h2>
                    <span class="status-badge" id="assignments-status">Ready</span>
                </div>
                <div class="card-body">
                    <p>Extract assignments and study group information from learning.london.edu</p>
                    <button class="btn btn-primary" onclick="runAssignments()" id="assignments-btn">
                        <span class="btn-icon">üìö</span>
                        Extract Assignments
                    </button>
                    <div class="output-container" id="assignments-output-container" style="display: none;">
                        <div class="output-header">
                            <span class="output-title">Output</span>
                            <button class="btn-clear" onclick="clearOutput('assignments')">Clear</button>
                        </div>
                        <pre class="output" id="assignments-output"></pre>
                    </div>
                </div>
            </div>

            <!-- Room Booking Card -->
            <div class="card">
                <div class="card-header">
                    <h2>Room Booking</h2>
                    <span class="status-badge" id="booking-status">Ready</span>
                </div>
                <div class="card-body">
                    <p>Book study rooms on lbsmobile.london.edu using configuration file</p>
                    <button class="btn btn-primary" onclick="bookRoom()" id="booking-btn">
                        <span class="btn-icon">üè¢</span>
                        Book Room
                    </button>
                    <div class="output-container" id="booking-output-container" style="display: none;">
                        <div class="output-header">
                            <span class="output-title">Output</span>
                            <button class="btn-clear" onclick="clearOutput('booking')">Clear</button>
                        </div>
                        <pre class="output" id="booking-output"></pre>
                    </div>
                </div>
            </div>

            <!-- LBS AI LLM Card -->
            <div class="card">
                <div class="card-header">
                    <h2>LBS AI Assistant</h2>
                    <span class="status-badge" id="llm-status">Ready</span>
                </div>
                <div class="card-body">
                    <p>Use LBS's AI to plan your week and answer questions about your assignments</p>

                    <!-- Quick Action: Plan Week -->
                    <div class="ai-action-section">
                        <h3 class="action-title">üìÖ Quick Action</h3>
                        <button class="btn btn-primary" onclick="planWeek()" id="plan-week-btn">
                            <span class="btn-icon">üóìÔ∏è</span>
                            Plan My Week + Suggest Room Booking
                        </button>
                        <p class="action-hint">Analyzes your assignments and creates an optimal study plan</p>
                    </div>

                    <div class="divider"></div>

                    <!-- Free Text Query -->
                    <div class="ai-action-section">
                        <h3 class="action-title">üí¨ Ask Anything</h3>
                        <div class="query-input-group">
                            <textarea
                                id="llm-query"
                                placeholder="Ask about your assignments, study group, or get study advice..."
                                rows="3"
                            ></textarea>
                        </div>
                        <button class="btn btn-secondary" onclick="queryLLM()" id="llm-btn">
                            <span class="btn-icon">ü§ñ</span>
                            Send Query
                        </button>
                        <p class="action-hint">AI has access to your assignment data and room booking config</p>
                    </div>

                    <div class="output-container" id="llm-output-container" style="display: none;">
                        <div class="output-header">
                            <span class="output-title">AI Response</span>
                            <button class="btn-clear" onclick="clearOutput('llm')">Clear</button>
                        </div>
                        <pre class="output" id="llm-output"></pre>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>LBS Study Group Manager ¬© 2025</p>
        </footer>
    </div>

    <script>
        // Poll interval for checking process status
        let pollIntervals = {};

        // Function to run assignment extraction
        async function runAssignments() {
            const btn = document.getElementById('assignments-btn');
            const status = document.getElementById('assignments-status');
            const outputContainer = document.getElementById('assignments-output-container');
            const output = document.getElementById('assignments-output');

            btn.disabled = true;
            status.textContent = 'Running...';
            status.className = 'status-badge status-running';
            outputContainer.style.display = 'block';
            output.textContent = 'Starting assignment extraction...\n';

            try {
                const response = await fetch('/api/run-assignments', {
                    method: 'POST'
                });

                if (response.ok) {
                    startPolling('assignments');
                } else {
                    const data = await response.json();
                    output.textContent = 'Error: ' + data.error;
                    btn.disabled = false;
                    status.textContent = 'Error';
                    status.className = 'status-badge status-error';
                }
            } catch (error) {
                output.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                status.textContent = 'Error';
                status.className = 'status-badge status-error';
            }
        }

        // Function to book a room
        async function bookRoom() {
            const btn = document.getElementById('booking-btn');
            const status = document.getElementById('booking-status');
            const outputContainer = document.getElementById('booking-output-container');
            const output = document.getElementById('booking-output');

            btn.disabled = true;
            status.textContent = 'Running...';
            status.className = 'status-badge status-running';
            outputContainer.style.display = 'block';
            output.textContent = 'Starting room booking...\n';

            try {
                const response = await fetch('/api/book-room', {
                    method: 'POST'
                });

                if (response.ok) {
                    startPolling('booking');
                } else {
                    const data = await response.json();
                    output.textContent = 'Error: ' + data.error;
                    btn.disabled = false;
                    status.textContent = 'Error';
                    status.className = 'status-badge status-error';
                }
            } catch (error) {
                output.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                status.textContent = 'Error';
                status.className = 'status-badge status-error';
            }
        }

        // Function to plan week with AI
        async function planWeek() {
            const btn = document.getElementById('plan-week-btn');
            const llmBtn = document.getElementById('llm-btn');
            const status = document.getElementById('llm-status');
            const outputContainer = document.getElementById('llm-output-container');
            const output = document.getElementById('llm-output');

            btn.disabled = true;
            llmBtn.disabled = true;
            status.textContent = 'Running...';
            status.className = 'status-badge status-running';
            outputContainer.style.display = 'block';
            output.textContent = 'Planning your week with AI...\n';

            try {
                const response = await fetch('/api/plan-week', {
                    method: 'POST'
                });

                if (response.ok) {
                    startPolling('llm');
                } else {
                    const data = await response.json();
                    output.textContent = 'Error: ' + data.error;
                    btn.disabled = false;
                    llmBtn.disabled = false;
                    status.textContent = 'Error';
                    status.className = 'status-badge status-error';
                }
            } catch (error) {
                output.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                llmBtn.disabled = false;
                status.textContent = 'Error';
                status.className = 'status-badge status-error';
            }
        }

        // Function to query LBS AI LLM
        async function queryLLM() {
            const btn = document.getElementById('llm-btn');
            const planBtn = document.getElementById('plan-week-btn');
            const status = document.getElementById('llm-status');
            const outputContainer = document.getElementById('llm-output-container');
            const output = document.getElementById('llm-output');
            const queryInput = document.getElementById('llm-query');
            const query = queryInput.value.trim();

            if (!query) {
                alert('Please enter a query');
                return;
            }

            btn.disabled = true;
            planBtn.disabled = true;
            status.textContent = 'Running...';
            status.className = 'status-badge status-running';
            outputContainer.style.display = 'block';
            output.textContent = 'Processing query...\n';

            try {
                const response = await fetch('/api/query-llm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                if (response.ok) {
                    startPolling('llm');
                } else {
                    const data = await response.json();
                    output.textContent = 'Error: ' + data.error;
                    btn.disabled = false;
                    planBtn.disabled = false;
                    status.textContent = 'Error';
                    status.className = 'status-badge status-error';
                }
            } catch (error) {
                output.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                planBtn.disabled = false;
                status.textContent = 'Error';
                status.className = 'status-badge status-error';
            }
        }

        // Start polling for output updates
        function startPolling(processType) {
            if (pollIntervals[processType]) {
                clearInterval(pollIntervals[processType]);
            }

            pollIntervals[processType] = setInterval(() => {
                updateOutput(processType);
            }, 1000);
        }

        // Update output for a specific process
        async function updateOutput(processType) {
            try {
                const response = await fetch(`/api/output/${processType}`);
                const data = await response.json();

                const output = document.getElementById(`${processType}-output`);
                const status = document.getElementById(`${processType}-status`);

                output.textContent = data.output;
                output.scrollTop = output.scrollHeight;

                if (data.running) {
                    status.textContent = 'Running...';
                    status.className = 'status-badge status-running';
                } else {
                    status.textContent = 'Ready';
                    status.className = 'status-badge status-ready';

                    // Re-enable buttons based on process type
                    if (processType === 'llm') {
                        document.getElementById('llm-btn').disabled = false;
                        document.getElementById('plan-week-btn').disabled = false;
                    } else {
                        const btn = document.getElementById(`${processType}-btn`);
                        if (btn) btn.disabled = false;
                    }

                    clearInterval(pollIntervals[processType]);
                }
            } catch (error) {
                console.error('Error updating output:', error);
            }
        }

        // Clear output for a specific process
        async function clearOutput(processType) {
            try {
                const response = await fetch(`/api/clear/${processType}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    document.getElementById(`${processType}-output`).textContent = '';
                    document.getElementById(`${processType}-output-container`).style.display = 'none';
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Initial status check on page load
        window.addEventListener('load', () => {
            ['assignments', 'booking', 'llm'].forEach(processType => {
                updateOutput(processType);
            });
        });
    </script>
</body>
</html>
